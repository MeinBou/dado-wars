<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DADO WARS ONLINE (Full Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDKs -->
    <script type="module">
        // Importiamo le funzioni dai CDN (necessario per farlo funzionare in un file HTML semplice)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- LA TUA CONFIGURAZIONE DI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBLb3l8-TsSWPTlOtFgWdnk-CEjMbysvc8",
            authDomain: "territorio-dado.firebaseapp.com",
            projectId: "territorio-dado",
            storageBucket: "territorio-dado.firebasestorage.app",
            messagingSenderId: "288563906866",
            appId: "1:288563906866:web:916a1374766e1b44952f2b",
            measurementId: "G-EJDCRWH64F"
        };

        // Inizializzazione Firebase
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        
        // ID univoco per separare i dati di questo gioco nel database
        window.appId = 'territorio-dado-game-v1';
        
        // Esponiamo le funzioni Firestore globalmente per usarle nel resto dello script
        window.fs = { doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion };

        // Login Anonimo automatico all'avvio
        signInAnonymously(window.auth).then(() => {
            console.log("Connesso a Firebase: territorio-dado");
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('screen-login').classList.remove('hidden');
        }).catch(e => {
            console.error(e);
            alert("Errore connessione Firebase: " + e.message + "\n\nAssicurati di aver abilitato 'Anonymous Auth' e creato il 'Firestore Database' nella console di Firebase.");
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap');
        
        body { font-family: 'Fredoka', sans-serif; background-color: #111827; color: white; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .grid-container { display: grid; grid-template-columns: repeat(var(--grid-cols), 1fr); gap: 1px; width: 100%; max-width: 600px; margin: 0 auto; padding: 4px; border-radius: 8px; }
        .cell { aspect-ratio: 1; background-color: #374151; border-radius: 2px; position: relative; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; overflow: hidden; background-size: cover; background-position: center; transition: all 0.2s; }
        .cell.void { background-color: transparent; border: none; pointer-events: none; }
        .cell.highlight-valid { box-shadow: inset 0 0 0 2px white; animation: pulse-green 1.5s infinite; z-index: 10; }
        .cell.highlight-attack { box-shadow: inset 0 0 0 2px #ef4444; animation: pulse-red 1.5s infinite; z-index: 10; }
        .cell.highlight-bomb { box-shadow: inset 0 0 0 2px #FCD34D; animation: pulse-yellow 1.5s infinite; z-index: 10; }
        .cell.highlight-source { box-shadow: inset 0 0 0 3px #3B82F6; animation: pulse-blue 1.5s infinite; z-index: 10; }
        .cell.is-head { border: 2px solid #FFF; z-index: 20; box-shadow: 0 0 10px rgba(255,255,255,0.8); }
        .cell.owned { box-shadow: inset 0 0 4px rgba(0,0,0,0.5); }
        
        @keyframes pulse-green { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.05); filter: brightness(1.2); } 100% { transform: scale(1); filter: brightness(1); } }
        @keyframes pulse-red { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(0.95); filter: brightness(0.8); } 100% { transform: scale(1); filter: brightness(1); } }
        @keyframes pulse-blue { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.05); filter: brightness(1.2); } 100% { transform: scale(1); filter: brightness(1); } }
        @keyframes pulse-yellow { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.05); filter: brightness(1.2); } 100% { transform: scale(1); filter: brightness(1); } }

        /* 3D Dice */
        .dice-scene { width: 60px; height: 60px; perspective: 600px; margin: 0 auto; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: translateZ(-30px); transition: transform 1s cubic-bezier(0.1, 0.9, 0.2, 1); }
        .cube.rolling { animation: spin 0.6s linear infinite; }
        @keyframes spin { 0% { transform: translateZ(-30px) rotateX(0deg) rotateY(0deg) rotateZ(0deg); } 100% { transform: translateZ(-30px) rotateX(360deg) rotateY(720deg) rotateZ(360deg); } }
        .cube__face { position: absolute; width: 60px; height: 60px; background: linear-gradient(145deg, #ffffff, #e6e6e6); border: 2px solid #d4d4d4; border-radius: 8px; display: flex; justify-content: center; align-items: center; }
        .dot { width: 10px; height: 10px; background: #1f2937; border-radius: 50%; position: absolute; }
        /* Dice Faces Positions */
        .cube__face--1 { transform: rotateY(0deg) translateZ(30px); } .cube__face--2 { transform: rotateY(180deg) translateZ(30px); } 
        .cube__face--3 { transform: rotateY(-90deg) translateZ(30px); } .cube__face--4 { transform: rotateY(90deg) translateZ(30px); } 
        .cube__face--5 { transform: rotateX(90deg) translateZ(30px); } .cube__face--6 { transform: rotateX(-90deg) translateZ(30px); }
        /* Dots positioning simplified for brevity */
        .cube__face--1 .dot:nth-child(1) { top: 25px; left: 25px; background: #ef4444; } 
        .cube__face--6 .dot:nth-child(1) { top: 10px; left: 10px; } .cube__face--6 .dot:nth-child(6) { bottom: 10px; right: 10px; }

        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .player-chip.active-turn { transform: scale(1.1); border-color: #60A5FA; box-shadow: 0 0 10px rgba(96, 165, 250, 0.5); }
        
        .mode-btn { @apply px-2 py-2 rounded-lg font-bold text-[9px] uppercase tracking-wider border transition-all; }
        .mode-btn.active { @apply bg-blue-600 border-blue-400 text-white shadow-[0_0_15px_rgba(37,99,235,0.5)]; }
        .mode-btn.inactive { @apply bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700; }

        .match-card { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 10px; width: 160px; flex-shrink: 0; display: flex; flex-direction: column; gap: 4px; position: relative; transition: all 0.3s ease; }
        .match-card.user-match { border-color: #FBBF24; box-shadow: 0 0 10px rgba(251, 191, 36, 0.2); }
        .t-row { display: flex; align-items: center; justify-content: space-between; font-size: 10px; padding: 4px; border-radius: 4px; background: rgba(0,0,0,0.2); }
        .t-row.winner { background: rgba(16, 185, 129, 0.2); border: 1px solid #059669; }
        .t-row.loser { opacity: 0.4; text-decoration: line-through; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col bg-gray-900 text-white overflow-hidden">

    <!-- LOADING -->
    <div id="loading-screen" class="absolute inset-0 bg-black z-[100] flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-dice-d20 fa-spin text-5xl text-blue-500 mb-4"></i>
            <p class="text-gray-400 font-bold animate-pulse">CONNESSIONE AL SERVER...</p>
        </div>
    </div>

    <!-- 0. LOGIN / LOBBY -->
    <div id="screen-login" class="flex-grow flex flex-col items-center justify-center p-4 fade-in h-full hidden">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">DADO WARS</h1>
            <p class="text-xs uppercase font-bold tracking-[0.4em] text-gray-400 mt-2">Online Tournament Edition</p>
        </div>
        <div class="glass-panel p-8 rounded-2xl w-full max-w-sm space-y-4">
            <input type="text" id="inp-nickname" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-center font-bold text-white focus:border-blue-500 outline-none" placeholder="Il tuo Nickname" maxlength="12">
            <button onclick="createLobby()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold shadow-lg">CREA LOBBY</button>
            <div class="flex gap-2">
                <input type="text" id="inp-code" class="w-24 bg-gray-800 border border-gray-600 rounded-xl text-center font-mono font-bold uppercase" placeholder="CODE" maxlength="4">
                <button onclick="joinLobby()" class="flex-grow bg-gray-700 hover:bg-gray-600 py-3 rounded-xl font-bold border border-gray-600">ENTRA</button>
            </div>
        </div>
    </div>

    <!-- LOBBY WAITING ROOM -->
    <div id="screen-lobby-wait" class="hidden flex-grow flex flex-col p-4 fade-in h-full items-center justify-center">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-md text-center">
            <h2 class="text-xl font-bold mb-2">CODICE LOBBY: <span id="lobby-code-display" class="text-blue-400 font-mono text-3xl">????</span></h2>
            <p class="text-xs text-gray-400 mb-4">Condividi questo codice con gli amici</p>
            <div id="lobby-player-list" class="space-y-2 mb-6 max-h-48 overflow-y-auto"></div>
            <div id="host-start-btn-area" class="hidden">
                <button onclick="goToSetup()" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-bold shadow-lg animate-pulse">VAI AL SETUP</button>
            </div>
            <div id="client-wait-msg" class="text-yellow-500 font-bold text-sm hidden">In attesa dell'Host...</div>
        </div>
    </div>

    <!-- 1. SETUP SCREEN (Host Controls, Client Views) -->
    <div id="screen-setup" class="hidden flex-grow flex flex-col items-center justify-center p-4 fade-in h-full">
        <div class="text-center shrink-0 mb-4">
            <h1 class="text-4xl font-bold text-white">IMPOSTAZIONI</h1>
            <p class="text-gray-400 text-[10px] uppercase font-bold tracking-widest">Solo l'Host può modificare</p>
        </div>

        <div class="glass-panel p-6 rounded-2xl w-full max-w-sm space-y-4 relative">
            <!-- Overlay for clients to prevent editing -->
            <div id="setup-blocker" class="absolute inset-0 z-50 bg-transparent hidden"></div>

            <div class="flex border-b border-gray-700 mb-2">
                <button onclick="if(isHost) updateSettings('setupType', 'QUICK')" id="tab-quick" class="flex-1 py-2 text-xs font-bold transition-colors">PARTITA VELOCE</button>
                <button onclick="if(isHost) updateSettings('setupType', 'TOURNAMENT')" id="tab-tourney" class="flex-1 py-2 text-xs font-bold transition-colors">TORNEO</button>
            </div>

            <!-- QUICK SETTINGS -->
            <div id="settings-quick" class="space-y-4">
                <div class="bg-gray-900/50 p-2 rounded-xl flex space-x-1">
                    <button onclick="if(isHost) updateSettings('mode', 'CLASSIC')" id="btn-mode-classic" class="mode-btn w-1/3">Classica</button>
                    <button onclick="if(isHost) updateSettings('mode', 'TOTAL_WAR')" id="btn-mode-war" class="mode-btn w-1/3">Totale</button>
                    <button onclick="if(isHost) updateSettings('mode', 'TACTICS')" id="btn-mode-tactics" class="mode-btn w-1/3">Tattica</button>
                </div>
                
                <div class="bg-gray-800 p-2 rounded flex items-center justify-between">
                    <label class="text-[9px] font-bold text-gray-400 uppercase">Mappa</label>
                    <select id="map-select" class="bg-gray-900 text-white text-xs p-1 rounded font-bold outline-none w-32 text-right" onchange="if(isHost) updateSettings('mapType', this.value)" disabled>
                        <option value="SQUARE">Quadrata</option>
                        <option value="ARENA">Arena</option>
                        <option value="DONUT">Ciambella</option>
                        <option value="ISLANDS">Arcipelago</option>
                        <option value="RANDOM">Casuale</option>
                    </select>
                </div>
                
                <div class="flex justify-between items-center bg-gray-800 p-2 rounded">
                    <label class="text-xs font-bold text-gray-400 uppercase">CPU Extra</label>
                    <div class="flex items-center space-x-3 bg-gray-900 rounded-lg px-2">
                        <button onclick="if(isHost) adjustCpu(-1)" class="px-2 font-bold">-</button>
                        <span id="val-cpuCount" class="text-blue-400 font-bold">0</span>
                        <button onclick="if(isHost) adjustCpu(1)" class="px-2 font-bold">+</button>
                    </div>
                </div>
            </div>

            <!-- TOURNAMENT SETTINGS -->
            <div id="settings-tourney" class="space-y-4 hidden">
                <div class="bg-gray-800 p-2 rounded">
                     <div class="text-[9px] uppercase text-gray-400 mb-1">Partecipanti Totali</div>
                     <select id="tourney-size" class="w-full bg-gray-900 text-white text-xs p-1 rounded font-bold" onchange="if(isHost) updateSettings('tourneySize', parseInt(this.value))" disabled>
                        <option value="8">8 Giocatori</option>
                        <option value="16">16 Giocatori</option>
                        <option value="32">32 Giocatori</option>
                     </select>
                </div>
                <div class="text-[10px] text-yellow-500 text-center italic">
                    I posti vuoti saranno riempiti da CPU.
                </div>
            </div>

            <!-- Navigation -->
            <button id="btn-setup-next" onclick="if(isHost) goToRoster()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 py-3 rounded-xl font-bold text-lg shadow-lg disabled:opacity-50">
                AVANTI <i class="fas fa-arrow-right ml-2"></i>
            </button>
            <p id="client-wait-setup" class="text-center text-xs text-yellow-500 font-bold hidden">L'HOST STA CONFIGURANDO...</p>
        </div>
    </div>

    <!-- 2. ROSTER SCREEN -->
    <div id="screen-roster" class="hidden flex-grow flex flex-col p-4 fade-in h-full">
        <h2 class="text-2xl font-bold text-center mb-4 text-white">SELEZIONE PERSONAGGIO</h2>
        <div class="glass-panel p-4 rounded-xl flex-grow flex flex-col overflow-hidden">
             <!-- Players Status List -->
             <div id="roster-status-list" class="flex overflow-x-auto space-x-2 mb-4 pb-2 border-b border-gray-700"></div>
             
             <!-- Grid -->
             <div class="grid grid-cols-4 md:grid-cols-6 gap-2 overflow-y-auto flex-grow p-1" id="roster-grid"></div>
        </div>
        <div class="mt-4 glass-panel p-3 rounded-xl flex justify-between items-center shrink-0">
             <div class="text-xs text-gray-400"><i class="fas fa-info-circle"></i> <span id="roster-info">Scegli il tuo avatar</span></div>
             <button id="btn-roster-ready" onclick="toggleReady()" class="bg-gray-600 px-6 py-3 rounded-xl font-bold">NON PRONTO</button>
             <button id="btn-start-game" onclick="launchGame()" class="hidden bg-green-600 hover:bg-green-500 px-6 py-3 rounded-xl font-bold shadow-lg">START</button>
        </div>
    </div>

    <!-- 3. BRACKET SCREEN -->
    <div id="screen-bracket" class="hidden flex-grow flex flex-col p-4 fade-in h-full relative bg-gray-900">
        <div class="text-center mb-2 shrink-0">
            <h2 class="text-2xl font-bold text-white">TORNEO</h2>
            <div id="bracket-round-name" class="text-sm text-yellow-400 font-bold uppercase">ROUND 1</div>
        </div>
        <div class="flex-grow overflow-x-auto overflow-y-hidden flex items-center px-4" id="bracket-scroll-area">
             <div id="bracket-container" class="flex gap-4 mx-auto"></div>
        </div>
        <div class="mt-4 glass-panel p-4 rounded-xl flex flex-col items-center justify-center shrink-0 w-full max-w-md mx-auto space-y-2">
            <div id="bracket-msg" class="text-sm text-gray-300">In attesa...</div>
            <button id="btn-play-match" onclick="enterMatch()" class="w-full bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-bold shadow-lg hidden">GIOCA MATCH</button>
            <button id="btn-advance-round" onclick="if(isHost) nextBracketRound()" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-bold shadow-lg hidden">PROSSIMO ROUND</button>
        </div>
    </div>

    <!-- 4. GAME SCREEN -->
    <div id="screen-game" class="hidden flex-grow flex flex-col h-screen overflow-hidden bg-gray-900 fade-in">
        <div class="leaderboard-bar w-full h-16 shrink-0 flex items-center space-x-2 px-4 overflow-x-auto scrollbar-hide z-30 shadow-2xl bg-gray-800 border-b border-gray-700" id="top-leaderboard"></div>
        
        <div class="flex-grow flex flex-col lg:flex-row overflow-hidden relative">
            <div class="flex-grow p-2 flex flex-col items-center justify-center relative overflow-hidden bg-gray-900/50">
                <div class="absolute top-2 right-2 z-20 bg-gray-800/80 px-3 py-1 rounded-full text-xs border border-gray-700">
                    ROUND <span id="game-round" class="text-white font-bold ml-1">1</span>
                </div>
                <div id="game-grid" class="grid-container transition-all"></div>
                <div id="instruction-banner" class="mt-4 bg-gray-800/90 px-6 py-2 rounded-full border border-gray-600 text-sm text-white shadow-xl min-h-[40px] flex items-center justify-center z-20">
                    <span id="instruction-text">...</span>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="w-full lg:w-80 bg-gray-800 border-t lg:border-t-0 lg:border-l border-gray-700 flex flex-col shadow-2xl z-20 h-[35vh] lg:h-full p-4">
                 <div class="flex items-center space-x-3 mb-4 p-3 bg-gray-700/50 rounded-xl border border-gray-600">
                      <img id="ap-avatar" src="" class="w-12 h-12 rounded-full border-2 bg-gray-900 object-cover">
                      <div class="overflow-hidden">
                           <div id="ap-name" class="font-bold truncate">...</div>
                           <div class="flex gap-1">
                               <span id="ap-status" class="text-[10px] bg-blue-600 px-1 rounded">...</span>
                               <span id="ap-item-badge" class="hidden text-[10px] bg-purple-600 px-1 rounded"><i class="fas fa-magic"></i></span>
                           </div>
                      </div>
                 </div>

                 <!-- Dice & Actions -->
                 <div class="flex space-x-4 h-32">
                      <div class="w-1/2 bg-gray-900/50 rounded-xl border border-gray-700 flex items-center justify-center">
                           <div class="dice-scene scale-75">
                                <div class="cube" id="dice-cube">
                                    <div class="cube__face cube__face--1"><div class="dot"></div></div>
                                    <div class="cube__face cube__face--2"><div class="dot"></div><div class="dot"></div></div>
                                    <div class="cube__face cube__face--3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                                    <div class="cube__face cube__face--4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                                    <div class="cube__face cube__face--5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                                    <div class="cube__face cube__face--6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                                </div>
                           </div>
                      </div>
                      <div class="w-1/2 relative">
                           <!-- ROLL BUTTON -->
                           <button id="btn-roll" onclick="performRoll()" class="hidden w-full h-full bg-gradient-to-br from-pink-600 to-rose-600 rounded-xl font-bold text-white shadow-lg flex flex-col items-center justify-center">
                                <i class="fas fa-dice text-3xl mb-1"></i> <span>LANCIA</span>
                           </button>
                           <!-- ACTIONS PANEL -->
                           <div id="panel-actions" class="hidden w-full h-full flex flex-col items-center justify-center bg-blue-900/30 rounded-xl border border-blue-500/50">
                                <div id="action-pts" class="text-4xl font-bold text-blue-400">0</div>
                                <span class="text-[9px] uppercase font-bold mb-1">AZIONI</span>
                                <button onclick="endTurn()" class="bg-gray-700 px-3 py-1 rounded text-xs">SALTA</button>
                           </div>
                           <!-- ITEM BUTTON -->
                           <button id="btn-use-item" onclick="activateItem()" class="hidden absolute -top-10 right-0 bg-purple-600 px-3 py-1 rounded text-xs font-bold shadow-lg">USA <i class="fas fa-bolt"></i></button>
                           <!-- WAIT MSG -->
                           <div id="panel-wait" class="w-full h-full flex items-center justify-center text-gray-500 text-xs font-bold border border-gray-700 border-dashed rounded-xl">ATTENDI...</div>
                      </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification" class="fixed top-10 left-1/2 transform -translate-x-1/2 z-[60] opacity-0 transition-opacity pointer-events-none">
        <div class="bg-gray-800/90 backdrop-blur border border-gray-600 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3">
             <i id="notif-icon" class="text-2xl text-yellow-400"></i>
             <div>
                 <h3 id="notif-title" class="font-bold text-sm text-white leading-none">Title</h3>
                 <p id="notif-msg" class="text-xs text-gray-300">Message</p>
             </div>
        </div>
    </div>

    <script>
        // --- ASSETS ---
        const PALETTE = ['#EF4444', '#F97316', '#F59E0B', '#84CC16', '#10B981', '#06B6D4', '#3B82F6', '#8B5CF6', '#EC4899', '#64748B', '#F43F5E', '#A855F7'];
        const ROSTER = [
            {name: "Aang", img: "https://i.pinimg.com/736x/05/01/fc/0501fc8ed44f7bd4ad9e74d9bb959669.jpg"}, {name: "Ben 10", img: "https://i.pinimg.com/736x/ad/5c/cd/ad5ccdba073abda30c152f7eac48447b.jpg"}, {name: "Bowser", img: "https://i.pinimg.com/1200x/cf/3f/ec/cf3fec1f6b9334e0255065f150fa97a9.jpg"},
            {name: "Bugs Bunny", img: "https://i.pinimg.com/1200x/ff/d1/66/ffd166e976132eb05bf59b5339a01931.jpg"}, {name: "Cell", img: "https://i.pinimg.com/736x/cd/e2/4c/cde24ca1463975e32a513dcd96d20cae.jpg"}, {name: "Doraemon", img: "https://i.pinimg.com/736x/b1/75/de/b175de80fb0f5ca9b5230f0b12f3c13c.jpg"},
            {name: "Elsa", img: "https://i.pinimg.com/736x/0a/e9/e8/0ae9e8606e505a0315e105b73a96e387.jpg"}, {name: "Goku", img: "https://i.pinimg.com/736x/cb/96/5a/cb965ab6c13eaf52f182474b6fc9a7d1.jpg"}, {name: "Homer", img: "https://i.pinimg.com/1200x/1d/b9/18/1db918fe2b5dff69f35186ad20cc1752.jpg"},
            {name: "Jerry", img: "https://i.pinimg.com/736x/be/2f/e1/be2fe1bde39e5005bdc4cea479dcf6f7.jpg"}, {name: "Kirby", img: "https://i.pinimg.com/736x/ba/e6/63/bae6637b3efecfd002f0c1f9605e53be.jpg"}, {name: "Kratos", img: "https://i.pinimg.com/736x/d9/d4/4f/d9d44f16329a4e72b4b8e45d41d83262.jpg"},
            {name: "Link", img: "https://i.pinimg.com/736x/be/29/0a/be290ac4f5b6f1de6f88ee2099e04da1.jpg"}, {name: "Luigi", img: "https://i.pinimg.com/1200x/0b/49/30/0b49308522463829166e76b0d914c8b8.jpg"}, {name: "Mario", img: "https://i.pinimg.com/736x/61/62/b5/6162b56bc61a4050bb34d7203e03642d.jpg"},
            {name: "Morty", img: "https://i.pinimg.com/736x/95/5c/dc/955cdc707097b8546e167c2188c4b5df.jpg"}, {name: "Pikachu", img: "https://i.pinimg.com/736x/ad/65/b6/ad65b669746561313925ffff392518bc.jpg"}, {name: "Rick", img: "https://i.pinimg.com/736x/95/5c/dc/955cdc707097b8546e167c2188c4b5df.jpg"},
            {name: "Shrek", img: "https://i.pinimg.com/1200x/cf/d2/85/cfd285a97021713f6f5cada516043233.jpg"}, {name: "Sonic", img: "https://i.pinimg.com/736x/ae/01/6c/ae016c6828620c2b981bbf92fd1219d4.jpg"}, {name: "Spongebob", img: "https://i.pinimg.com/1200x/27/e0/2e/27e02eadbe6a321a7d0a9641a394c811.jpg"},
            {name: "Spiderman", img: "https://i.pinimg.com/736x/c3/ed/77/c3ed7755f4cbee4cd34316139d132597.jpg"}, {name: "Batman", img: "https://i.pinimg.com/736x/1a/1b/2c/1a1b2c3d.jpg"}, {name: "Yoda", img: "https://i.pinimg.com/736x/4d/5e/6f/4d5e6f.jpg"}
        ];

        const ITEMS = {
            BONUS: { icon: 'fa-star', color: 'text-yellow-300', instant: true },
            BOMB: { icon: 'fa-bomb', color: 'text-red-500', instant: false },
            TRAP: { icon: 'fa-skull', color: 'text-gray-400', instant: false },
            OPPORTUNITY: { icon: 'fa-hourglass-start', color: 'text-purple-400', instant: true },
            EMPIRE: { icon: 'fa-crown', color: 'text-yellow-400', instant: false }
        };

        // --- GLOBAL VARIABLES (SYNCED) ---
        let myUid = null;
        let myNick = "Player";
        let lobbyCode = null;
        let isHost = false;
        let dbState = null; // The "Source of Truth" from Firestore
        let unsubLobby = null;

        // --- AUTH & LOGIN ---
        window.onload = () => { setTimeout(() => { if(window.auth?.currentUser) myUid=window.auth.currentUser.uid; }, 1000); };

        async function createLobby() {
            const nick = document.getElementById('inp-nickname').value.trim();
            if(!nick) return alert("Nickname richiesto!");
            myNick = nick;
            lobbyCode = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            const initialData = {
                code: lobbyCode,
                hostId: myUid,
                status: 'LOBBY',
                settings: { setupType: 'QUICK', mode: 'CLASSIC', mapType: 'SQUARE', tourneySize: 8, cpuCount: 0 },
                players: [{ uid: myUid, name: nick, charIdx: -1, isReady: false, color: PALETTE[0], isHost: true }],
                gameState: { grid: [], turnIndex: 0, round: 1, actionsLeft: 0, phase: 'ROLL', diceValue: 1, animating: false },
                tournament: { matches: [], roundIndex: 0 }
            };

            await window.fs.setDoc(window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'lobbies', lobbyCode), initialData);
            enterLobby();
        }

        async function joinLobby() {
            const nick = document.getElementById('inp-nickname').value.trim();
            const code = document.getElementById('inp-code').value.trim().toUpperCase();
            if(!nick || !code) return alert("Dati mancanti!");
            myNick = nick;
            lobbyCode = code;

            const ref = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'lobbies', lobbyCode);
            const snap = await window.fs.getDoc(ref);
            if(!snap.exists()) return alert("Lobby inesistente!");
            
            const data = snap.data();
            if(data.status !== 'LOBBY') return alert("Partita già in corso!");
            if(data.players.length >= 16) return alert("Lobby piena!");

            const newPlayer = {
                uid: myUid, name: nick, charIdx: -1, isReady: false, color: PALETTE[data.players.length % PALETTE.length], isHost: false
            };
            await window.fs.updateDoc(ref, { players: window.fs.arrayUnion(newPlayer) });
            enterLobby();
        }

        function enterLobby() {
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-lobby-wait').classList.remove('hidden');
            document.getElementById('lobby-code-display').innerText = lobbyCode;

            const ref = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'lobbies', lobbyCode);
            unsubLobby = window.fs.onSnapshot(ref, (doc) => {
                if(!doc.exists()) { location.reload(); return; }
                const data = doc.data();
                dbState = data;
                isHost = (myUid === data.hostId);
                syncUI(data);
            });
        }

        // --- MAIN SYNC FUNCTION ---
        function syncUI(data) {
            // 1. LOBBY WAITING
            if(data.status === 'LOBBY') {
                document.getElementById('screen-lobby-wait').classList.remove('hidden');
                document.getElementById('screen-setup').classList.add('hidden');
                const list = document.getElementById('lobby-player-list');
                list.innerHTML = data.players.map(p => `
                    <div class="flex items-center justify-between bg-gray-800 p-2 rounded border border-gray-700">
                        <span class="${p.uid===myUid?'text-blue-400 font-bold':''}">${p.name}</span>
                        ${p.isHost ? '<i class="fas fa-crown text-yellow-500"></i>' : ''}
                    </div>`).join('');
                
                if(isHost) document.getElementById('host-start-btn-area').classList.remove('hidden');
                else document.getElementById('client-wait-msg').classList.remove('hidden');
            }
            
            // 2. SETUP
            else if (data.status === 'SETUP') {
                document.getElementById('screen-lobby-wait').classList.add('hidden');
                document.getElementById('screen-setup').classList.remove('hidden');
                
                // Sync Controls
                document.getElementById('tab-quick').className = data.settings.setupType === 'QUICK' ? 'flex-1 py-2 text-xs font-bold text-blue-400 border-b-2 border-blue-500' : 'flex-1 py-2 text-xs font-bold text-gray-400';
                document.getElementById('tab-tourney').className = data.settings.setupType === 'TOURNAMENT' ? 'flex-1 py-2 text-xs font-bold text-blue-400 border-b-2 border-blue-500' : 'flex-1 py-2 text-xs font-bold text-gray-400';
                
                document.getElementById('settings-quick').classList.toggle('hidden', data.settings.setupType !== 'QUICK');
                document.getElementById('settings-tourney').classList.toggle('hidden', data.settings.setupType !== 'TOURNAMENT');

                // Mode Buttons
                ['CLASSIC','TOTAL_WAR','TACTICS'].forEach(m => {
                    const btn = document.getElementById(`btn-mode-${m === 'TOTAL_WAR' ? 'war' : m.toLowerCase()}`);
                    if(btn) btn.className = data.settings.mode === m ? 'mode-btn active w-1/3' : 'mode-btn inactive w-1/3';
                });
                
                document.getElementById('map-select').value = data.settings.mapType;
                document.getElementById('map-select').disabled = !isHost;
                document.getElementById('val-cpuCount').innerText = data.settings.cpuCount || 0;
                document.getElementById('tourney-size').value = data.settings.tourneySize || 8;
                document.getElementById('tourney-size').disabled = !isHost;

                if(!isHost) {
                    document.getElementById('setup-blocker').classList.remove('hidden');
                    document.getElementById('btn-setup-next').classList.add('hidden');
                    document.getElementById('client-wait-setup').classList.remove('hidden');
                } else {
                    document.getElementById('setup-blocker').classList.add('hidden');
                }
            }

            // 3. ROSTER
            else if (data.status === 'ROSTER') {
                document.getElementById('screen-setup').classList.add('hidden');
                document.getElementById('screen-roster').classList.remove('hidden');
                renderRoster(data);
            }

            // 4. GAME (Quick or Match)
            else if (data.status === 'GAME' || data.status === 'MATCH_ACTIVE') {
                document.getElementById('screen-roster').classList.add('hidden');
                document.getElementById('screen-bracket').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('hidden');
                renderGame(data);
                // CPU Turn Logic (Host Only)
                if(isHost && data.status === 'GAME') checkCpuTurn(data);
            }

            // 5. BRACKET
            else if (data.status === 'BRACKET') {
                document.getElementById('screen-roster').classList.add('hidden');
                document.getElementById('screen-game').classList.add('hidden');
                document.getElementById('screen-bracket').classList.remove('hidden');
                renderBracket(data);
            }
        }

        // --- HOST ACTIONS (WRITES) ---
        async function updateSettings(key, val) {
            if(!isHost) return;
            const update = {};
            update[`settings.${key}`] = val;
            await window.fs.updateDoc(getRef(), update);
        }

        async function adjustCpu(delta) {
            if(!isHost) return;
            let newCount = (dbState.settings.cpuCount || 0) + delta;
            if(newCount < 0) newCount = 0;
            if(newCount + dbState.players.length > 8) newCount = 8 - dbState.players.length; // Max 8 in quick
            await updateSettings('cpuCount', newCount);
        }

        async function goToSetup() {
            await window.fs.updateDoc(getRef(), { status: 'SETUP' });
        }

        async function goToRoster() {
            await window.fs.updateDoc(getRef(), { status: 'ROSTER' });
        }

        // --- ROSTER LOGIC ---
        function renderRoster(data) {
            const myPlayer = data.players.find(p => p.uid === myUid);
            const grid = document.getElementById('roster-grid');
            grid.innerHTML = '';
            
            // Render Status List
            const statusList = document.getElementById('roster-status-list');
            statusList.innerHTML = data.players.map(p => `
                <div class="flex flex-col items-center min-w-[60px]">
                     <div class="w-10 h-10 rounded-full border-2 ${p.isReady ? 'border-green-500' : 'border-red-500'} bg-gray-800 overflow-hidden">
                         ${p.charIdx !== -1 ? `<img src="${ROSTER[p.charIdx].img}" class="w-full h-full object-cover">` : ''}
                     </div>
                     <span class="text-[9px] truncate w-full text-center mt-1">${p.name}</span>
                </div>
            `).join('');

            // Grid
            const takenIndices = new Set(data.players.map(p => p.charIdx).filter(i => i !== -1));
            ROSTER.forEach((char, idx) => {
                const isTaken = takenIndices.has(idx);
                const isMine = myPlayer.charIdx === idx;
                
                const el = document.createElement('div');
                el.className = `aspect-square rounded-xl overflow-hidden border-2 cursor-pointer relative ${isMine ? 'border-green-500 ring-2 ring-green-500' : (isTaken ? 'grayscale opacity-30 border-transparent cursor-not-allowed' : 'border-gray-700 hover:border-white')}`;
                el.innerHTML = `<img src="${char.img}" class="w-full h-full object-cover">`;
                
                if(!isTaken && !myPlayer.isReady) {
                    el.onclick = async () => {
                        const newPlayers = [...dbState.players];
                        const meIdx = newPlayers.findIndex(p => p.uid === myUid);
                        newPlayers[meIdx].charIdx = idx;
                        await window.fs.updateDoc(getRef(), { players: newPlayers });
                    };
                }
                grid.appendChild(el);
            });

            // Button State
            const btnReady = document.getElementById('btn-roster-ready');
            btnReady.innerText = myPlayer.isReady ? "PRONTO!" : "CONFERMA";
            btnReady.className = myPlayer.isReady ? "bg-green-600 px-6 py-3 rounded-xl font-bold" : "bg-gray-600 hover:bg-gray-500 px-6 py-3 rounded-xl font-bold";
            btnReady.disabled = myPlayer.charIdx === -1;

            const allReady = data.players.every(p => p.isReady);
            const btnStart = document.getElementById('btn-start-game');
            if(isHost) {
                btnStart.classList.toggle('hidden', !allReady);
            }
        }

        async function toggleReady() {
            const newPlayers = [...dbState.players];
            const meIdx = newPlayers.findIndex(p => p.uid === myUid);
            newPlayers[meIdx].isReady = !newPlayers[meIdx].isReady;
            await window.fs.updateDoc(getRef(), { players: newPlayers });
        }

        async function launchGame() {
            if(!isHost) return;
            const s = dbState.settings;
            
            // IF QUICK GAME
            if(s.setupType === 'QUICK') {
                // Generate Grid
                const totalPlayers = dbState.players.length + (s.cpuCount || 0);
                const grid = generateGrid(s.mapType, 10, totalPlayers);
                
                // Finalize Players List (Humans + CPUs)
                let finalPlayers = dbState.players.map(p => ({
                    id: p.uid, name: p.name, img: ROSTER[p.charIdx].img, color: p.color, type: 'HUMAN',
                    isDead: false, heldItem: null, hasCurse: false, hasTrap: false
                }));
                
                // Add CPUs
                const takenChars = new Set(dbState.players.map(p => p.charIdx));
                for(let i=0; i<s.cpuCount; i++) {
                    let cIdx = -1;
                    do { cIdx = Math.floor(Math.random() * ROSTER.length); } while(takenChars.has(cIdx));
                    takenChars.add(cIdx);
                    finalPlayers.push({
                        id: `cpu_${i}`, name: ROSTER[cIdx].name, img: ROSTER[cIdx].img, color: PALETTE[(finalPlayers.length)%PALETTE.length], type: 'CPU',
                        isDead: false, heldItem: null
                    });
                }

                // Initial Spawn
                assignSpawns(grid, finalPlayers);

                await window.fs.updateDoc(getRef(), {
                    status: 'GAME',
                    gamePlayers: finalPlayers,
                    'gameState.grid': grid,
                    'gameState.turnIndex': 0,
                    'gameState.phase': 'ROLL'
                });
            } else {
                // TOURNAMENT INIT
                initTournament();
            }
        }

        // --- GAMEPLAY LOGIC ---
        function renderGame(data) {
            const gs = data.gameState;
            const players = data.gamePlayers || []; // Use gamePlayers array which includes CPUs
            const turnPlayer = players[gs.turnIndex];
            const isMyTurn = turnPlayer.id === myUid;
            
            // Header
            document.getElementById('game-round').innerText = gs.round;
            document.getElementById('ap-name').innerText = turnPlayer.name;
            document.getElementById('ap-avatar').src = turnPlayer.img;
            document.getElementById('ap-avatar').style.borderColor = turnPlayer.color;
            document.getElementById('ap-status').innerText = isMyTurn ? "TOCCA A TE!" : "IN ATTESA...";
            document.getElementById('ap-status').className = isMyTurn ? "text-[10px] bg-green-600 px-1 rounded animate-pulse" : "text-[10px] bg-gray-600 px-1 rounded";
            
            // Item Badge
            const badge = document.getElementById('ap-item-badge');
            if(turnPlayer.heldItem) {
                badge.classList.remove('hidden');
                badge.innerHTML = `<i class="fas ${ITEMS[turnPlayer.heldItem].icon}"></i>`;
            } else badge.classList.add('hidden');

            // Controls Visibility
            const btnRoll = document.getElementById('btn-roll');
            const panelAct = document.getElementById('panel-actions');
            const panelWait = document.getElementById('panel-wait');
            const btnItem = document.getElementById('btn-use-item');

            btnRoll.classList.add('hidden');
            panelAct.classList.add('hidden');
            panelWait.classList.add('hidden');
            btnItem.classList.add('hidden');

            if(gs.animating) {
                document.getElementById('dice-cube').className = 'cube rolling';
                panelWait.classList.remove('hidden');
                panelWait.innerText = "DADO IN CORSO...";
            } else {
                const rot = getRotation(gs.diceValue);
                document.getElementById('dice-cube').className = 'cube';
                document.getElementById('dice-cube').style.transform = `translateZ(-30px) rotateX(${rot.x}deg) rotateY(${rot.y}deg)`;

                if(isMyTurn) {
                    if(gs.phase === 'ROLL') btnRoll.classList.remove('hidden');
                    else {
                        panelAct.classList.remove('hidden');
                        document.getElementById('action-pts').innerText = gs.actionsLeft;
                        if(turnPlayer.heldItem) btnItem.classList.remove('hidden');
                    }
                } else {
                    panelWait.classList.remove('hidden');
                    panelWait.innerText = `TURNO DI ${turnPlayer.name.toUpperCase()}`;
                }
            }

            // Grid
            const container = document.getElementById('game-grid');
            container.style.setProperty('--grid-cols', 10); // Standard 10x10
            container.innerHTML = '';

            gs.grid.forEach((row, y) => {
                row.forEach((cell, x) => {
                    const d = document.createElement('div');
                    if(cell.type === 'void') {
                        d.className = 'cell void';
                    } else {
                        d.className = 'cell border-gray-700/50';
                        if(cell.owner !== -1) {
                            const owner = players[cell.owner];
                            d.style.backgroundColor = owner.color;
                            d.style.backgroundImage = `linear-gradient(0deg, ${owner.color}D9, ${owner.color}D9), url('${owner.img}')`;
                            d.classList.add('owned');
                        }
                        
                        if(cell.item && cell.item !== 'none') {
                             d.innerHTML = `<i class="fas ${ITEMS[cell.item].icon} ${ITEMS[cell.item].color} drop-shadow-md"></i>`;
                        }

                        // Interactions
                        if(isMyTurn && !gs.animating) {
                             if(gs.phase === 'EXPAND' || gs.phase === 'SELECT_BOMB') {
                                 // Basic validation on client for highlighting
                                 let valid = false;
                                 if(gs.phase === 'EXPAND') valid = isValidMove(gs.grid, x, y, gs.turnIndex);
                                 if(gs.phase === 'SELECT_BOMB') valid = (cell.owner !== -1 && cell.owner !== gs.turnIndex);

                                 if(valid) {
                                     d.classList.add(cell.owner !== -1 ? 'highlight-attack' : 'highlight-valid');
                                     d.onclick = () => doMove(x, y);
                                 }
                             }
                        }
                    }
                    container.appendChild(d);
                });
            });
            
            // Instruction Banner
            const banner = document.getElementById('instruction-text');
            if(gs.phase === 'ROLL') banner.innerText = "Lancia il dado per ottenere punti azione!";
            else if(gs.phase === 'EXPAND') banner.innerText = "Clicca sui territori adiacenti per espanderti.";
            else if(gs.phase === 'SELECT_BOMB') banner.innerText = "BOMBA! Seleziona un territorio nemico da distruggere!";
        }

        // --- ACTIONS (DB WRITES) ---
        async function performRoll() {
            // Optimistic UI
            document.getElementById('dice-cube').className = 'cube rolling';
            await window.fs.updateDoc(getRef(), { 'gameState.animating': true });
            
            // Host or Client calculates? Better let client calculate but server verifies? 
            // For simplicity, client calculates, writes result.
            const val = Math.floor(Math.random() * 6) + 1;
            
            setTimeout(async () => {
                await window.fs.updateDoc(getRef(), { 
                    'gameState.diceValue': val,
                    'gameState.actionsLeft': val,
                    'gameState.phase': 'EXPAND',
                    'gameState.animating': false
                });
                if(val === 0) endTurn(); // Fallback logic
            }, 1000);
        }

        async function doMove(x, y) {
            const gs = dbState.gameState;
            if(gs.actionsLeft <= 0) return;

            // Clone grid
            const newGrid = JSON.parse(JSON.stringify(gs.grid));
            const cell = newGrid[y][x];
            
            // Bomb Logic
            if(gs.phase === 'SELECT_BOMB') {
                 cell.owner = gs.turnIndex;
                 await window.fs.updateDoc(getRef(), {
                     'gameState.grid': newGrid,
                     'gameState.phase': 'EXPAND',
                     'gamePlayers': updatePlayerItem(dbState.gamePlayers, gs.turnIndex, null) // remove bomb
                 });
                 return;
            }

            // Normal Move
            cell.owner = gs.turnIndex;
            let newItem = null;
            let bonusAction = 0;

            if(cell.item && cell.item !== 'none') {
                const it = ITEMS[cell.item];
                if(it.instant) {
                     if(cell.item === 'BONUS') bonusAction = 1;
                     if(cell.item === 'OPPORTUNITY') { /* Logic for extra turn could go here */ }
                     showNotif(it.icon, 'BONUS!', 'Hai trovato un oggetto!');
                } else {
                     newItem = cell.item;
                     showNotif(it.icon, 'OGGETTO!', 'Aggiunto all\'inventario');
                }
                cell.item = 'none';
            }

            let updates = {
                'gameState.grid': newGrid,
                'gameState.actionsLeft': gs.actionsLeft - 1 + bonusAction
            };
            
            if(newItem) {
                updates['gamePlayers'] = updatePlayerItem(dbState.gamePlayers, gs.turnIndex, newItem);
            }

            await window.fs.updateDoc(getRef(), updates);
        }

        async function activateItem() {
            const gs = dbState.gameState;
            const p = dbState.gamePlayers[gs.turnIndex];
            if(!p.heldItem) return;

            if(p.heldItem === 'BOMB') {
                await window.fs.updateDoc(getRef(), { 'gameState.phase': 'SELECT_BOMB' });
            } 
            // Add other items logic here...
        }

        async function endTurn() {
            const gs = dbState.gameState;
            const players = dbState.gamePlayers;
            let nextIdx = (gs.turnIndex + 1) % players.length;
            let nextRound = gs.round;
            if(nextIdx === 0) nextRound++;

            // Check win condition (if only 1 player has territory)
            // Simplified for brevity: if offline logic had `isDead`, here we check territory counts
            
            await window.fs.updateDoc(getRef(), {
                'gameState.turnIndex': nextIdx,
                'gameState.round': nextRound,
                'gameState.actionsLeft': 0,
                'gameState.phase': 'ROLL',
                'gameState.diceValue': 1
            });
        }

        // --- CPU LOGIC (HOST ONLY) ---
        async function checkCpuTurn(data) {
            const gs = data.gameState;
            const player = data.gamePlayers[gs.turnIndex];
            
            if(player.type === 'CPU' && gs.phase === 'ROLL' && !gs.animating) {
                console.log("CPU Rolling...");
                await performRoll();
            }
            else if(player.type === 'CPU' && gs.phase === 'EXPAND' && !gs.animating) {
                if(gs.actionsLeft > 0) {
                     // Find valid move
                     const validMoves = [];
                     gs.grid.forEach((r, y) => r.forEach((c, x) => {
                         if(isValidMove(gs.grid, x, y, gs.turnIndex)) {
                             // Basic heuristic: prioritize empty or weak
                             validMoves.push({x, y});
                         }
                     }));
                     
                     if(validMoves.length > 0) {
                         const move = validMoves[Math.floor(Math.random() * validMoves.length)];
                         await setTimeout(() => doMove(move.x, move.y), 500);
                     } else {
                         await endTurn();
                     }
                } else {
                    await endTurn();
                }
            }
        }

        // --- TOURNAMENT LOGIC (Simplified for Online) ---
        async function initTournament() {
             // 1. Create Tournament Players
             // ... Logic to create bracket tree ...
             // For this MVP sync, let's just create a mock bracket state
             const players = dbState.players.map(p => ({
                 id: p.uid, name: p.name, img: ROSTER[p.charIdx].img, type: 'HUMAN'
             }));
             // Fill with CPU
             while(players.length < 8) {
                 players.push({ id: `cpu_${players.length}`, name: `Bot ${players.length}`, img: ROSTER[players.length].img, type: 'CPU' });
             }
             
             // Create Matches
             const matches = [];
             for(let i=0; i<4; i++) {
                 matches.push({
                     id: i, p1: players[i*2], p2: players[i*2+1], status: 'PENDING', winner: null
                 });
             }

             await window.fs.updateDoc(getRef(), {
                 status: 'BRACKET',
                 'tournament.matches': matches,
                 'tournament.roundIndex': 0
             });
        }

        function renderBracket(data) {
            const container = document.getElementById('bracket-container');
            container.innerHTML = '';
            
            data.tournament.matches.forEach(m => {
                const isMyMatch = (m.p1.id === myUid || m.p2.id === myUid);
                const div = document.createElement('div');
                div.className = `match-card ${isMyMatch ? 'user-match' : ''}`;
                div.innerHTML = `
                    <div class="t-row ${m.winner?.id === m.p1.id ? 'winner' : ''}">
                        <img src="${m.p1.img}" class="w-4 h-4 rounded-full"> <span>${m.p1.name}</span>
                    </div>
                    <div class="t-row ${m.winner?.id === m.p2.id ? 'winner' : ''}">
                        <img src="${m.p2.img}" class="w-4 h-4 rounded-full"> <span>${m.p2.name}</span>
                    </div>
                `;
                
                if(isMyMatch && m.status === 'PENDING') {
                    document.getElementById('btn-play-match').classList.remove('hidden');
                    document.getElementById('bracket-msg').innerText = "Tocca a te! Gioca il match.";
                    div.classList.add('animate-pulse', 'border-yellow-500');
                }
                container.appendChild(div);
            });
        }

        async function enterMatch() {
            // Find my match
            const match = dbState.tournament.matches.find(m => (m.p1.id === myUid || m.p2.id === myUid) && m.status === 'PENDING');
            if(!match) return;

            // Generate temporary grid for this 1v1
            const grid = generateGrid('SQUARE', 8, 2);
            // Setup 1v1 Game State
            await window.fs.updateDoc(getRef(), {
                status: 'MATCH_ACTIVE',
                gamePlayers: [
                    {...match.p1, color: PALETTE[0], isDead:false, heldItem:null}, 
                    {...match.p2, color: PALETTE[1], isDead:false, heldItem:null}
                ],
                'gameState.grid': grid,
                'gameState.turnIndex': 0,
                'gameState.matchId': match.id
            });
            
            // Note: After match ends, we need logic to return to BRACKET state and update winner.
        }

        // --- UTILS ---
        function getRef() { return window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'lobbies', lobbyCode); }
        function getRotation(v){ const m={1:{x:0,y:0},2:{x:0,y:-180},3:{x:0,y:90},4:{x:0,y:-90},5:{x:-90,y:0},6:{x:90,y:0}}; return m[v]||m[1]; }
        
        function updatePlayerItem(players, idx, item) {
            const newPlayers = JSON.parse(JSON.stringify(players));
            newPlayers[idx].heldItem = item;
            return newPlayers;
        }

        function showNotif(icon, title, msg) {
            const n = document.getElementById('notification');
            document.getElementById('notif-icon').className = `fas ${icon} text-2xl text-yellow-400`;
            document.getElementById('notif-title').innerText = title;
            document.getElementById('notif-msg').innerText = msg;
            n.classList.remove('opacity-0');
            setTimeout(() => n.classList.add('opacity-0'), 2500);
        }

        function generateGrid(type, size, pCount) {
             let grid = [];
             for(let y=0; y<size; y++) {
                 let row = [];
                 for(let x=0; x<size; x++) {
                     let isVoid = false;
                     // Map Logic
                     if(type === 'ARENA' && Math.sqrt((x-size/2)**2 + (y-size/2)**2) > size/2) isVoid = true;
                     else if(type === 'DONUT' && Math.sqrt((x-size/2)**2 + (y-size/2)**2) < size/4) isVoid = true;
                     
                     // Random Item
                     let item = 'none';
                     if(!isVoid && Math.random() < 0.1) item = ['BONUS','BOMB'][Math.floor(Math.random()*2)];

                     row.push({ owner: -1, type: isVoid?'void':'normal', item: item });
                 }
                 grid.push(row);
             }
             return grid;
        }

        function assignSpawns(grid, players) {
             const size = grid.length;
             const corners = [{x:0,y:0}, {x:size-1,y:size-1}, {x:0,y:size-1}, {x:size-1,y:0}, {x:size/2,y:0}, {x:size/2,y:size-1}];
             players.forEach((p, i) => {
                 let pos = corners[i % corners.length];
                 if(grid[Math.floor(pos.y)][Math.floor(pos.x)].type !== 'void') {
                     grid[Math.floor(pos.y)][Math.floor(pos.x)].owner = i;
                 }
             });
        }

        function isValidMove(grid, x, y, pid) {
             if(grid[y][x].owner === pid || grid[y][x].type === 'void') return false;
             const d = [[0,1],[0,-1],[1,0],[-1,0]];
             for(let k of d) {
                 let nx = x + k[0], ny = y + k[1];
                 if(nx >= 0 && nx < grid.length && ny >= 0 && ny < grid.length) {
                     if(grid[ny][nx].owner === pid) return true;
                 }
             }
             return false;
        }

    </script>
</body>
</html>